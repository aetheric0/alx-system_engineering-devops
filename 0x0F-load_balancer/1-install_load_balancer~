#!/usr/bin/env bash
# Installs load balancer
apt-get-update
apt-get install --no-install-recommends software-properties-common
apt-repository ppa:vbernat/haproxy-2.8
apt-get install haproxy=2.8\*

# Checks if the frontend already exists
if ! grep -q "frontend" /etc/haproxy/haproxy.cfg; then
    sed -i "/frontend/a\
frontend myfrontend
  mode http
  bind :80
  default_backend web_servers
" /etc/haproxy/haproxy.cfg
fi

# Checks if the backend already exists
if ! grep -q "backend" /etc/haproxy/haproxy.cfg; then
    sed -i "/backend/a\
backend web_servers
  mode http
  balance roundrobin
  server 327114-web-01 3.84.168.250 check
  server 327114-web-02 54.87.172.213 check
" /etc/haproxy/haproxy.cfg;
fi

service restart haproxy
